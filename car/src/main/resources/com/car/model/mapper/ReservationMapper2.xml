<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.car.model.mapper.ReservationMapper">

	<resultMap type="Board" id="boardMap">
		<id property="boardNo" column="boardno" />
		<result property="boardTitle" column="boardtitle" />
		<result property="boardContent" column="boardcontent" />
		<result property="boardRegDate" column="boardregdate" />
		<result property="boardCount" column="boardcount" />
		<result property="boardKind" column="boardkind" />
		<result property="boardType" column="boardtype" />
		<result property="deleted" column="deleted" />
		<result property="groupNo" column="groupno" />
		<result property="step" column="step" />
		<result property="depth" column="depth" />
		<result property="memberId" column="memberid" />
		<collection property="comments" column="boardno"
			select="selectBoardCommentsByBoardNo" />
	</resultMap>

	<resultMap type="Board" id="boardMap2">
		<id property="boardNo" column="boardno" />
		<result property="boardTitle" column="boardtitle" />
		<result property="boardContent" column="boardcontent" />
		<result property="boardRegDate" column="boardregdate" />
		<result property="boardCount" column="boardcount" />
		<result property="boardKind" column="boardkind" />
		<result property="boardType" column="boardtype" />
		<result property="deleted" column="deleted" />
		<result property="groupNo" column="groupno" />
		<result property="step" column="step" />
		<result property="depth" column="depth" />
		<result property="memberId" column="memberid" />
		
	</resultMap>

	<insert id="insertBoard" parameterType="Board" useGeneratedKeys="true"
		keyProperty="boardNo" keyColumn="boardno">
		INSERT INTO board
		(boardno, boardtitle, memberid, boardcontent, boardkind, groupno, step)
		VALUES
		(board_sequence.nextval, #{boardTitle}, #{memberId}, #{boardContent}, #{boardKind},
		board_sequence.currval, 1)
	</insert>
	
	<insert id="insertBoardUploadFile" parameterType="BoardUploadFile">
		INSERT INTO BOARDUPLOADFILE (uploadfileno, boardno, savedfilename, userfilename, downloadcount)
		VALUES (BOARDUPLOADFILE_SEQUENCE.nextval, #{boardNo}, #{savedFileName}, #{userFileName}, 0)
	</insert>
	
	
	
	<select id="selectBoardList" parameterType="hashMap" resultMap="boardMap2">
		SELECT *
		FROM
		(
		SELECT
		rownum idx, s.*
		FROM

		(
		SELECT
		boardno, boardtitle,
		boardkind, memberid,
		boardregdate, boardcount,
		deleted,
		groupno, step, depth
		FROM
		board
		ORDER BY groupno DESC, step ASC
		) s
		)
		WHERE
		idx >= #{start} AND idx <![CDATA[<]]>
		#{last}
	</select>


	<select id="selectBoardByBoardNo" parameterType="int" resultMap="boardMap">
		SELECT
		boardno, boardtitle, memberid, boardcontent,
		boardregdate,
		boardcount,
		deleted, groupno, step, depth
		FROM board
		WHERE boardno =
		#{boardNo} AND deleted
		= '0'
	</select>

	<select id="selectBoardCount" resultType="int">
		SELECT COUNT(*) FROM
		board
	</select>
	
	<update id="BoardReadCount" parameterType="int">
	UPDATE board
	SET boardcount = boardcount + 1
	WHERE boardno = #{boardNo}
	</update>

	<select id="selectBoardCommentsByBoardNo" parameterType="int"
	resultType="BoardComment">
	SELECT commentno, boardno, memberid, commentcontent,
	commentregdate
	FROM boardcomment
	WHERE boardno = #{boardNo}
	</select>

	<update id="deleteBoard" parameterType="int">
	UPDATE board SET deleted
	= '1' WHERE boardno = #{boardNo}
	</update>

	<update id="updateBoard" parameterType="Board">
	UPDATE board
	SET boardtitle = #{boardTitle}, boardcontent = #{boardContent}
	WHERE boardno = #{boardNo}
	</update>

	<update id="increaseStepNo" parameterType="Board">
	UPDATE board
	SET step = step + 1
	WHERE step >= #{step} AND groupno = #{groupNo}
	</update>

	<insert id="insertBoardReply" parameterType="Board">
	INSERT INTO board
	(
	boardno, boardtitle, memberid, boardcontent,
	groupno, step, depth
	)
	VALUES
	(
	board_sequence.nextval, #{boardTitle}, #{memberId}, #{boardContent},
	#{groupNo}, #{step}, #{depth}
	)
	</insert>

	<insert id="insertBoardComment" parameterType="BoardComment">
	INSERT INTO
	boardcomment
	(
	commentno, boardno, memberid, commentcontent
	)
	VALUES
	(
	boardcomment_sequence.nextval, #{boardNo}, #{memberId}, #{commentContent}
	)
	</insert>
	
	<update id="updateComment" parameterType="BoardComment">
	UPDATE boardcomment
	SET
	commentcontent = #{commentContent}
	WHERE commentno = #{commentNo}
	</update>

	<delete id="deleteComment" parameterType="int">
	DELETE FROM
	boardcomment
	WHERE commentno = #{commentNo}
	</delete>
	
	<select id="selectUploadFilesByBoardNo"
		parameterType="int" resultType="BoardUploadFile">
		SELECT uploadFileNo, boardNo, savedFileName, userFileName, downloadCount
		FROM boarduploadfile 
		WHERE boardno = #{boardNo}
	</select>
	
	<select id="selectUploadFileByUploadFileNo"
		parameterType="int" resultType="BoardUploadFile">
		SELECT uploadFileNo, boardNo, savedFileName, userFileName
		FROM boarduploadfile 
		WHERE uploadfileno = #{uploadFileNo}
	</select>
	
	<select id="selectBoardSearchType" parameterType="hashMap" resultMap="boardMap2">
		select *
		From (select rownum idx, s.*
		From (select * from board
		where boardkind = #{boardSearch}) s ) where idx >= #{start} AND idx <![CDATA[<]]> #{last}
	</select>
	
	<select id="selectBoardSearchCount" parameterType="string" resultType="int">
		select COUNT(*) from board
		where boardkind = #{boardSearch}
	</select>
	

</mapper>